!function(a,b,c,d,e){{var f=d.Model.extend({defaults:{itemId:"",buttons:["object","array","string","color","map","image"],type:"string",parentId:"0",parentType:"object",level:0,order:0,key:"",value:""},initialize:function(){this.get("itemId")?this.cid=this.get("itemId"):this.set({itemId:this.cid})}}),g=d.Collection.extend({model:f,comparator:function(a){return[a.get("level"),a.get("order")]}}),h=d.View.extend({tagName:"li",template:null,events:{"click span.delete":"remove","change input":"updateModel","click button.select-image":"selectImage"},initialize:function(){e.bindAll(this,"render","unrender","removeTree","remove","updateModel","selectImage","updateOrder"),c(this.el).attr("id",this.model.get("itemId")),this.template=e.template(c("#"+this.model.get("parentType")+"-"+this.model.get("type")).html()),("string"===this.model.get("type")||"image"===this.model.get("type")||"color"===this.model.get("type")||"map"===this.model.get("type"))&&this.model.set({buttons:[]}),this.buttons=this.getButtonsHtml(this.model.get("buttons")),this.model.bind("remove",this.unrender),this.model.bind("updateModel",this.updateModel)},getButtonsHtml:function(a){var b="";return e(a).each(function(a){b+=c("#button-add-"+a).html()}),b?'<span class="plus-icon"></span>'+b:b},render:function(){var a=this;return this.$el.html(this.template(this.model.toJSON())+this.buttons),this.$el.children("ul, ol").sortable({update:function(){a.updateOrder()},handle:".sort-handle"}),this},unrender:function(){c(this.el).remove()},updateOrder:function(){e(this.model.collection.models).each(function(a){a.set({order:c("li#"+a.get("itemId")).index()})},this)},removeTree:function(a){e(a.collection.where({parentId:a.get("itemId")})).each(function(a){this.removeTree(a)},this),a.destroy()},remove:function(){this.removeTree(this.model)},selectImage:function(a){a.preventDefault();var b=this,c=wp.media();c.on("select",function(){var a=c.state().get("selection"),d=[];a.each(function(a){d.push(a.attributes)}),b.model.set({value:d}),b.$el.find(".image-preview").attr("src",d[0].sizes.thumbnail.url)}),c.open()},updateModel:function(){switch(this.model.get("type")){case"string":case"object":case"array":this.model.set({key:this.$el.find("input.key").val(),value:this.$el.find("input.value").val()});break;case"image":case"color":case"map":this.model.set({key:this.$el.find("input.key").val()})}}}),i=d.View.extend({el:c("#content-json-editor"),events:{"click button.add-item":"addItem"},initialize:function(){e.bindAll(this,"render","addItem","appendItem","updateContent","updateOrder");var a=this;this.collection=c("#content").val()?new g(JSON.parse(c("#content").val())):new g,this.collection.bind("add",this.appendItem),this.collection.bind("change reset add remove",this.updateContent),this.render(),this.$el.children("ul, ol").sortable({update:function(){a.updateOrder()},handle:".sort-handle"})},render:function(){var a=this;c(this.el).append(this.getButtonsHtml(Object.getPrototypeOf(this.collection).model.prototype.defaults.buttons)),c(this.el).append("<ul></ul>"),e(this.collection.models).each(function(b){a.appendItem(b)},this)},getButtonsHtml:function(a){var b="";return e(a).each(function(a){b+=c("#button-add-"+a).html()}),b?'<span class="plus-icon"></span>'+b:b},addItem:function(a){a.preventDefault();var b="LI"===a.target.parentElement.tagName?this.collection.findWhere({itemId:a.target.parentElement.id}):!1,c=new f({type:a.target.className.match(/item-([^\s]+)/)[1],parentId:b?b.get("itemId"):"0",parentType:b?b.get("type"):"object",level:b?b.get("level")+1:0});this.collection.add(c)},appendItem:function(a){var b=new h({model:a}),d=null,e=null,f=null;"0"!==a.get("parentId")?c("#"+a.get("parentId")+">ul, #"+a.get("parentId")+">ol").append(b.render().el):this.$el.children("ul").append(b.render().el),a.set({order:b.$el.index()}),b.$el.find(".color-picker").wpColorPicker({change:function(b,c){a.set({value:c.color.toString()})}}),b.$el.find("div.map").hasClass("map")&&(f=b.$el.find("div.map").attr("data-latLng")?b.$el.find("div.map").attr("data-latLng").replace(/[()]/g,"").split(", "):"44.97022530459223, -93.289053440094".split(", "),d=new google.maps.Map(b.$el.find("div.map")[0],{center:new google.maps.LatLng(f[0],f[1]),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:10}),e=new google.maps.Marker({position:new google.maps.LatLng(f[0],f[1]),map:d,draggable:!0}),google.maps.event.addListener(e,"dragend",function(){console.log(e.getPosition().toString()),a.set({value:e.getPosition().toString()})},!1))},updateOrder:function(){e(this.collection.models).each(function(a){a.set({order:c("li#"+a.get("itemId")).index()})},this)},updateContent:function(){this.collection.sort(),c("#content").val(JSON.stringify(this.collection))}});new i}}(this,document,jQuery,Backbone,_);